<!DOCTYPE html>
<html>
  <head>
    <title>Multi-Task Image Classifier</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        margin-top: 40px;
      }
      #output {
        margin-top: 20px;
        font-size: 1.2em;
      }
      #status {
        font-weight: bold;
        margin-top: 20px;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #555;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-left: 8px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      img {
        max-width: 200px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Upload Image for Prediction</h1>
    <input type="file" accept="image/*" id="fileInput" />
    <div><img id="preview" /></div>
    <p id="status"></p>
    <div id="output"></div>

    <script>
      let model,
        labels = {};

      async function loadLabels() {
        const [types, manus, conds] = await Promise.all([
          fetch("./asset_types.json").then((res) => res.json()),
          fetch("./manufacturers.json").then((res) => res.json()),
          fetch("./conditions.json").then((res) => res.json()),
        ]);
        labels.assetTypes = types;
        labels.manufacturers = manus;
        labels.conditions = conds;
      }

      let modelReady = false;

      window.onload = async () => {
        // ‚úÖ Set WebGL to use float32 precision (prevent TF.js from reducing to float16)
        tf.env().set("WEBGL_FORCE_F16_TEXTURES", false);

        model = await tf.loadGraphModel("./tfjs_model/model.json");
        await loadLabels();
        modelReady = true;
        document.getElementById("fileInput").disabled = false;
      };

      document
        .getElementById("fileInput")
        .addEventListener("change", async (event) => {
          if (!modelReady) {
            alert("Model is still loading. Please wait...");
            return;
          }
          const file = event.target.files[0];
          if (!file) return;

          const fileInput = document.getElementById("fileInput");
          const imgElement = document.getElementById("preview");
          const status = document.getElementById("status");
          const outputDiv = document.getElementById("output");

          fileInput.disabled = true;
          status.innerHTML = `üîÑ Predicting image: <em>${file.name}</em> <span class="spinner"></span>`;
          outputDiv.innerHTML = "";

          imgElement.src = URL.createObjectURL(file);
          const img = new Image();
          img.src = imgElement.src;
          await img.decode();

          const inputTensor = tf.tidy(() => {
            const mean = tf.tensor1d([0.485, 0.456, 0.406]).mul(255);
            const std = tf.tensor1d([0.229, 0.224, 0.225]).mul(255);

            return tf.browser
              .fromPixels(img)
              .resizeBilinear([224, 224])
              .toFloat()
              .sub(mean)
              .div(std)
              .expandDims(0) // [1, 224, 224, 3]
              .transpose([0, 3, 1, 2]); // [1, 3, 224, 224]
          });

          try {
            const output = await model.execute({ input: inputTensor });
            console.log("Output shape:", output.shape);
            const logits = await output.data(); // Get raw values from tensor
            console.log("TFJS logits:", Array.from(logits)); // Print as array for comparison

            const [typeLogits, manuLogits, condLogits] = tf.split(
              output,
              [16, 79, 5],
              1
            );

            const predType = tf.softmax(typeLogits).argMax(1).dataSync()[0];
            const predManu = tf.softmax(manuLogits).argMax(1).dataSync()[0];
            const predCond = tf.softmax(condLogits).argMax(1).dataSync()[0];

            outputDiv.innerHTML = `
            <strong>Prediction:</strong><br/>
            Asset Type: ${labels.assetTypes[predType]} (${predType})<br/>
            Manufacturer: ${labels.manufacturers[predManu]} (${predManu})<br/>
            Condition: ${labels.conditions[predCond]} (${predCond})
          `;

            status.textContent = "‚úÖ Prediction complete!";
            tf.dispose([
              output,
              inputTensor,
              typeLogits,
              manuLogits,
              condLogits,
            ]);
          } catch (err) {
            console.error(err);
            status.textContent = "‚ùå Prediction failed.";
          }

          fileInput.disabled = false;
        });
    </script>
  </body>
</html>
